<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
<head>
  <title>Ubiquity Web Search Commands</title>
</head>
<body>
<p>This xhtml source contains commands for searching the Web.  Its
corresponding feed is <a href="search.html">here</a>.</p>
<script src="fake-infrastructure.js"></script>
<div id="google-search" style="display: none;">
{for result in results}
<div class="gresult">
  <div>
    <a href="${result.unescapedUrl}">${result.title}</a>
  </div>
  <xul:description class="gresult-content">${result.content}</xul:description>
  <div class="gresult-url">${result.visibleUrl}</div>
</div>
{forelse}
  <b>Your search - ${searchTerm} - did not match any documents. </b>
{/for}
</div>
<div id="amazon-search" style="display: none;">
Found ${numitems} books on Amazon matching <b>${query}</b>
{for item in items}
    <div style="clear: both; padding: 10px 0px;">
        <a href="${item.url}">
            {if item.image}
                <img
                    src="${item.image.src}"
                    style="float: left; margin-right: 10px; height: ${item.image.height}px; width: ${item.image.width}px;"
                    />
            {/if}
            
            <u>${item.title}</u>
        </a>
        <small>
            {if item.author}
                <br />by ${item.author}
            {/if}
            
            {if item.price}
                <br />for ${item.price.amount} (${item.price.currency})
            {/if}
        </small>
    </div>
{/for}
</div>
<div id="flickr-search" style="display: none;">
<b>${nummatches} photos were found on Flickr.</b><br/><br/>
<table style="border-width: 0px;">
{for photo in photos}
  {if photo_index % numcols == 0}
  <tr height="100">
  {/if} 
  <td>
    <a href="http://www.flickr.com/photos/${photo.owner}/${photo.id}" title="${photo.title|escape}">
      <img src="http://farm${photo.farm}.static.flickr.com/${photo.server}/${photo.id}_${photo.secret}_t.jpg" />
    </a>
  </td>
  {if photo_index % numcols == (numcols - 1)}
  </tr>
  {/if}
{/for}
</table>
</div>
<div id="weather-search" style="display: none;">
<style>
img {float: left; }
.weather{ font-family: arial, helvetica; color:white;}
.temp{ font-size: 60px; }
</style>
<div class="weather">
  Weather For ${location}<br />
  <img src='${w.img}'/>
  <div class="temp">
    {if w.temp_units == "fahrenheit"} 
      ${w.tempf}°F 
    {else}
      ${w.tempc}°C
    {/if}
    <br/>
  </div>
  <div class="extra">
    ${w.condition}<br/>
    ${w.wind}<br/>
    ${w.humidity}<br/>  
  </div>
</div>
</div>
<div id="wikipedia-search" style="display: none;">
Wikipedia articles found matching <b>${query}</b>:
<br/><br/>
{for article in results}
  <div style="clear: both;">
    <b><a href="${article.title|wikilink}">${article.title}</a></b>
    <br/>
    <div style="margin-left: 20px; font-size: 80%;" wikiarticle="${article.title}">
      <i>Retreiving article summary...</i>
    </div>
  </div>
{forelse}
  <b>No articles found</b>
{/for}
</div>
<div id="yahoo-search" style="display: none;">
{for result in results}
<div class="gresult">
  <div>
    <a href="${result.Url}">${result.Title}</a>
  </div>
  <xul:description class="gresult-content">${result.Summary}</xul:description>
</div>
{/for}
</div>
<div id="yelp-search" style="display: none;">
<style>
.biz {
  margin-bottom: 10px;
}

.name{ font-size: 120%;}

.biz a {
  color: #0066cc;
  text-decoration: underline;
  font-size: small;
}

.biz img{ position: relative; top: 15px;}

.content {
  margin-right: 10px;
  font-size: x-small;  
}

</style>

{for biz in businesses}
<div class="biz">
  <img src="${biz.photo_url_small}" height="40" width="40"/>
  {var phone = biz.phone.replace(/(\d\d\d)(\d\d\d)(\d\d\d\d)/, "$1.$2.$3")}
  <span class="name"><a href="${biz.url}">${biz.name}</a></span> in ${biz.city} (${phone}) —
  ${biz.avg_rating} stars.
</div>
{/for}
</div>
<div id="youtube-search" style="display: none;">
  <p>
   Found <b>${numresults}</b> YouTube Videos matching <b>${query}</b>
  </p>
  {for entry in results}
  <div style="display: block; margin-bottom: 10px; clear: both;" >
   <a style="color: blue; font-size: 14px;" href="${entry.link[0].href}">
   <img style="float:left; margin-right: 10px; border:thin solid white; height: ${entry['media$group']['media$thumbnail'][0].height}px; width: ${entry['media$group']['media$thumbnail'][0].width}px;"
   src="${entry['media$group']['media$thumbnail'][0].url}" />
   ${entry.title.$t}
   </a>
   <br/>
   <small>${entry['media$group']['yt$duration'].seconds} seconds</small>
   <p>
     <!-- TODO: for some stupid reason, this doesn't work or am I missing something? -->
     <!-- {if entry.content.$t.length > 300}
         ${entry.content.$t.substr(0,300)} ...
      {else}
         ${entry.content.$t}
      {/if} -->
      
      ${entry.content.$t.substr(0,300)}
   </p>
  </div>
  {/for}
  <br/><br/>
</div>
<script class="commands"><![CDATA[
CmdUtils.CreateCommand({
  name: "search",
  icon: "chrome://ubiquity/skin/icons/search.png",
  description: "Search using your installed search engines",
  takes: {query: noun_arb_text},
  modifiers: {"with": noun_type_searchengine},
  preview: function(previewBlock, inputObject, queryModifiers) {
    var searchEngine = queryModifiers["with"].data;
    if(!searchEngine)
      searchEngine = noun_type_searchengine.getDefault();

    var previewTemplate = "Search using <b>${engine}</b> for:<br /><b>${query}</b>";
    var previewData = {
      engine: searchEngine.name,
      query: inputObject.text
    };
    previewBlock.innerHTML = CmdUtils.renderTemplate(previewTemplate, previewData);
  },
  execute: function(inputObject, queryModifiers) {
    var searchEngine = queryModifiers["with"].data;
    if(!searchEngine)
      searchEngine = noun_type_searchengine.getDefault();

    var searchSubmission = searchEngine.getSubmission(inputObject.text, null);
    Utils.openUrlInBrowser(searchSubmission.uri.spec, searchSubmission.postData);
  }
});

CmdUtils.makeSearchCommand({
  name: "Google",
  url: "http://www.google.com/search?q={QUERY}",
  icon: "http://www.google.com/favicon.ico",
  description: "Searches Google for your words.",
  preview: function(pblock, directObject) {
    var searchTerm = directObject.text;
    // Don't even display any text before fetching search results,
    // since the results come back nearly instantaneously. In the
    // future, we can display a throbber.
    //var pTemplate = "Searches Google for <b>${query}</b>";
    //var pData = {query: searchTerm};
    //pblock.innerHTML = CmdUtils.renderTemplate(pTemplate, pData);

    var url = "http://ajax.googleapis.com/ajax/services/search/web";
    var params = { v: "1.0", q: searchTerm };

    CmdUtils.previewGet( pblock, url, params, function(data) {
      var numToDisplay = 3;
      var results = data.responseData.results.splice( 0, numToDisplay );

      pblock.innerHTML = CmdUtils.renderTemplate( jQuery("#google-search", feed.dom).html(),
						  {results:results, searchTerm:searchTerm}
						);
      }, "json");
  }
});

function fetchWikipediaArticle(previewBlock, articleTitle, langCode) {
  /* TODO
   - apply CSS max-height & overflow-y to summary container
  */
  if (!langCode)
    langCode = "en";
  var apiUrl = "http://" + langCode + ".wikipedia.org/w/api.php";
  var apiParams = {
    format: "json",
    action: "parse",
    page: articleTitle
  };

  CmdUtils.previewAjax(previewBlock, {
    type: "GET",
    url: apiUrl,
    data: apiParams,
    datatype: "string",
    error: function() {
      previewBlock.innerHTML = "<i>Error retreiving summary.</i>";
    },
    success: function(responseData) {
      responseData = Utils.decodeJson(responseData);

      var tempElement = CmdUtils.getHiddenWindow().document.createElementNS("http://www.w3.org/1999/xhtml", "div");
      tempElement.innerHTML = responseData.parse.text["*"];

      //take only the text from summary because links won't work either way
      var articleSummary = jQuery(tempElement).find('p').eq(0).text();
      //remove citations [3], [citation needed], etc.
      //TODO: also remove audio links (.audiolink & .audiolinkinfo)
      articleSummary = articleSummary.replace(/\[([^\]]+)\]/g,"");

      //TODO: remove "may refer to" summaries

      var articleImageSrc = jQuery(tempElement).find(".infobox img").attr("src") ||
      jQuery(tempElement).find(".thumbimage").attr("src");

      var previewTemplate = "<img src=\"${img}\" style=\"float: left; max-width: 80px; max-height: 80px; background-color: white;\" />" +
      "<span class=\"wikisummary\">${summary}</span>";

      var previewData = {
        img: articleImageSrc,
        summary: articleSummary
      };

      previewBlock.innerHTML = CmdUtils.renderTemplate(previewTemplate, previewData);
    }
  });
}

CmdUtils.CreateCommand({
  name: "wikipedia",
  synonyms: ["lookup"],
  takes: {search: noun_arb_text},
  modifiers: {in: noun_type_language},
  locale: "en-US",
  homepage: "http://theunfocused.net/moz/ubiquity/verbs/",
  author: {name: "Blair McBride", email: "blair@theunfocused.net"},
  contributors: ["Viktor Pyatkovka"],
  license: "MPL",
  icon: "http://en.wikipedia.org/favicon.ico",
  description: "Searches Wikipedia for your words, in a given language.",
  preview: function(previewBlock, directObject, mods) {
    var langCode = mods.in.data || "en";
    var apiUrl = "http://" + langCode + ".wikipedia.org/w/api.php";

    var searchText = jQuery.trim(directObject.text);
    if(searchText.length < 1) {
      var previewStr = "Searches Wikipedia";
      if (mods.in.text) {
        var language = mods.in.text[0].toUpperCase() + mods.in.text.slice(1);
	previewStr = previewStr + " in " + language;
      }
      previewBlock.innerHTML = previewStr;
      return;
    }

    var previewTemplate = "Searching Wikipedia for <b>${query}</b> ...";
    var previewData = {query: searchText};
    previewBlock.innerHTML = CmdUtils.renderTemplate(previewTemplate, previewData);

    var apiParams = {
      format: "json",
      action: "query",
      list: "search",
      srlimit: 5, // is this a good limit?
      srwhat: "text",
      srsearch: searchText
    };

    CmdUtils.previewAjax(previewBlock, {
      type: "GET",
      url: apiUrl,
      data: apiParams,
      datatype: "string",
      error: function() {
        previewBlock.innerHTML = "Error searching Wikipedia";
      },
      success: function(searchResponse) {
        searchResponse = Utils.decodeJson(searchResponse);

        if(!("query" in searchResponse && "search" in searchResponse.query)) {
          previewBlock.innerHTML = "Error searching Wikipedia";
          return;
        }

        function generateWikipediaLink(title) {
          var wikipediaUrl = "http://" + langCode + ".wikipedia.org/wiki/";
          return wikipediaUrl + title.replace(/ /g, "_");
        }

        previewData = {
          query: searchText,
          results: searchResponse.query.search,
          _MODIFIERS: {wikilink: generateWikipediaLink}
        };

        previewBlock.innerHTML = CmdUtils.renderTemplate(
          jQuery("#wikipedia-search", feed.dom).html(),
          previewData);

        jQuery(previewBlock).find("div[wikiarticle]").each(function() {
          var article = jQuery(this).attr("wikiarticle");
          fetchWikipediaArticle(this, article, langCode);
        });

      }
    });
  },
  execute: function(directObject, mods) {
    var lang = mods.in.data || "en";
    var searchUrl = "http://" + lang + ".wikipedia.org/wiki/Special:Search";
    var searchParams = {search: directObject.text};
    Utils.openUrlInBrowser(searchUrl + Utils.paramsToString(searchParams));
  }
});

CmdUtils.makeSearchCommand({
  name: "IMDB",
  synonyms: ["movie", "actor"],
  url: "http://www.imdb.com/find?s=all&q={QUERY}&x=0&y=0",
  icon: "http://i.imdb.com/favicon.ico",
  description: "Searches the Internet Movie Database for your words."
});


CmdUtils.makeSearchCommand({
  name: "yahoo-search",
  url: "http://search.yahoo.com/search?p={QUERY}&ei=UTF-8",
  icon: "http://search.yahoo.com/favicon.ico",
  description: "Searches <a href=\"http://search.yahoo.com\">Yahoo</a> for pages matching your words.",
  preview: function(pblock, directObject){
    //TODO: Figure out some way around rate limits
    //Currently, Yahoo rate limits to 5000 queries per IP per day
    var searchTerm = directObject.text;
    var pTemplate = "Searches Yahoo for <b>${query}</b>";
    var pData = {query: searchTerm};
    pblock.innerHTML = CmdUtils.renderTemplate(pTemplate, pData);

    var url = "http://search.yahooapis.com/WebSearchService/V1/webSearch";
    var params = {
      appid: "wZ.3jHnV34GC4QakIuzfgHTGiU..1SfNPwPAuasmt.L5ytoIPOuZAdP1txE4s6KfRBp9",
      query: searchTerm,
      results: 3,
      output: "json"
    };

    CmdUtils.previewGet( pblock, url, params, function(data) {
      pblock.innerHTML = CmdUtils.renderTemplate(
        jQuery("#yahoo-search", feed.dom).html(),
        {results:data.ResultSet.Result}
      );
    }, "json");
  }
});


CmdUtils.makeSearchCommand({
  name: "amazon-search",
  icon: "http://www.amazon.com/favicon.ico",
  description: "Searches <a href=\"http://www.amazon.com\">Amazon</a> for books matching your words.",
  url: "http://www.amazon.com/s/ref=nb_ss_gw?url=search-alias%3Dstripbooks&field-keywords={QUERY}",
  preview: function(previewBlock, directObject) {
    if(!directObject.text || directObject.text.length < 1) {
      previewBlock.innerHTML = "Searches for books on Amazon";
        return;
    }

    previewBlock.innerHTML = "Searching Amazon for books matching <b>" + directObject.summary + "</b>";

    var apiUrl = "http://ecs.amazonaws.com/onca/xml";
    var apiParams = {
      Service: "AWSECommerceService",
      AWSAccessKeyId: "08WX39XKK81ZEWHZ52R2",
      Version: "2008-08-19",
      Operation: "ItemSearch",
      Condition: "All",
      ResponseGroup: "ItemAttributes,Images",
      SearchIndex: "Books",
      Title: directObject.text
    };

    CmdUtils.previewAjax(previewBlock, {
      type: "GET",
      url: apiUrl,
      data: apiParams,
      dataType: "xml",
      error: function() {
        previewBlock.innerHTML = "Error searching Amazon.";
      },
      success: function(responseData) {
        const AMAZON_MAX_RESULTS = 5;

        responseData = jQuery(responseData);
        var items = [];

        responseData.find("Items Item").slice(0, AMAZON_MAX_RESULTS).each(function(itemIndex) {
          var itemDetails = jQuery(this);

          var newItem = {
            title: itemDetails.find("ItemAttributes Title").text(),
            url: itemDetails.find("DetailPageURL").text()
          };

          if(itemDetails.find("ItemAttributes Author").length > 0) {
            newItem.author = itemDetails.find("ItemAttributes Author").text();
          }

          if(itemDetails.find("ItemAttributes ListPrice").length > 0) {
            newItem.price = {
              amount: itemDetails.find("ItemAttributes ListPrice FormattedPrice").text(),
              currency: itemDetails.find("ItemAttributes ListPrice CurrencyCode").text()
            };
          }

          if(itemDetails.find("SmallImage").length > 0) {
            newItem.image = {
              src: itemDetails.find("SmallImage:first URL").text(),
              height: itemDetails.find("SmallImage:first Height").text(),
              width: itemDetails.find("SmallImage:first Width").text()
            };
          }

          items.push(newItem);
        });

        var previewData = {
          query: directObject.summary,
          numitems: responseData.find("Items TotalResults").text(),
          items: items
        };

	previewBlock.innerHTML = CmdUtils.renderTemplate(
          jQuery("#amazon-search", feed.dom).html(),
          previewData);
      }
    });
  }
});


CmdUtils.makeSearchCommand({
  name: "YouTube",
  synonyms: ["video"],
  url: "http://www.youtube.com/results?search_type=search_videos&search_sort=relevance&search_query={QUERY}&search=Search",
  icon: "http://www.youtube.com/favicon.ico",
  description: "Searches <a href=\"http://www.youtube.com\">YouTube</a> for videos matching your words.",
  preview: function(pblock, directObject){
    var searchTerm = directObject.text;
    pblock.innerHTML = "Searches Youtube for <b>" + directObject.summary + "</b>";

    if(searchTerm.length < 1) {
      pblock.innerHTML = "Searches for videos on Youtube";
      return;
    }

    pblock.innerHTML = "Searches Youtube for <b>" + directObject.summary + "</b>";
    
    var url = "http://gdata.youtube.com/feeds/api/videos";
    var params = {
      alt: "json",
	    "max-results": 3,
      vq: searchTerm
    };

    CmdUtils.previewGet( pblock, url, params, function(data) {
      
      var previewData = {
    	    results: data.feed.entry,
          query: directObject.summary,
          numresults: data.feed['openSearch$totalResults']['$t']
      };
            
      pblock.innerHTML = CmdUtils.renderTemplate(
        jQuery("#youtube-search", feed.dom).html(),
        previewData);
      
    }, "json");
  }
});

CmdUtils.makeSearchCommand({
  name: "Flickr",
  synonyms: ["images"],
  url: "http://www.flickr.com/search/?q={QUERY}&w=all",
  icon: "http://www.flickr.com/favicon.ico",
  description: "Searches <a href=\"http://www.flickr.com\">Flickr</a> for pictures matching your words.",
  preview : function(previewBlock, inputObject){
    var inputText = inputObject.text;

    if(inputText.length < 1) {
      previewBlock.innerHTML = "Searches for photos on Flickr.";
      return;
    }

    previewBlock.innerHTML = "Searching for photos on Flickr...";

    var apiUrl = "http://api.flickr.com/services/rest/";
    var apiParams = {
      api_key: "4ca9aaaf5c2d83260eba9ab68ac1b1ac",
      format: "json",
      nojsoncallback: 1,
      method: "flickr.photos.search",
      media: "photos",
      text: inputText,
      per_page: 8,
      sort: "relevance"
    };

    CmdUtils.previewAjax(previewBlock, {
      type: "GET",
      url: apiUrl,
      data: apiParams,
      datatype: "string",
      error: function() {
        previewBlock.innerHTML = "<i>Error searching Flickr.</i>";
      },
      success: function(responseData) {
        responseData = Utils.decodeJson(responseData);

        if(responseData.stat != "ok") {
          previewBlock.innerHTML = "<i>Error searching Flickr.</i>";
          return;
        }

        var previewData = {
          numcols: 4,
          nummatches: responseData.photos.total,
          photos: responseData.photos.photo
        };

        previewBlock.innerHTML = CmdUtils.renderTemplate(
          jQuery("#flickr-search", feed.dom).html(),
          previewData);
    }
  });
}
});

CmdUtils.makeSearchCommand({
  name: "Bugzilla",
  url: "https://bugzilla.mozilla.org/buglist.cgi?query_format=specific&order=relevance+desc&bug_status=__open__&content={QUERY}",
  icon: "http://www.mozilla.org/favicon.ico",
  description: "Searches <a href=\"http://bugzilla.mozilla.com\">Bugzilla</a> for Mozilla bugs matching the given words."
});

CmdUtils.makeSearchCommand({
  name: "msn-search",
  url: "http://search.msn.com/results.aspx?q={QUERY}",
  icon: "http://search.msn.com/favicon.ico",
  description: "Searches <a href=\"http://search.msn.com\">MSN</a> for the given words.",
  preview: function(pBlock, directObj) {
    if (directObj.text)
      pBlock.innerHTML = "Searches MSN for " + directObj.text;
    else
      pBlock.innerHTML = "Searches MSN for the given words.";
  }
});

CmdUtils.makeSearchCommand({
  name: "ebay-search",
  url: "http://search.ebay.com/search/search.dll?satitle={QUERY}",
  icon: "http://search.ebay.com/favicon.ico",
  description: "Searches <a href=\"http://search.ebay.com\">EBay</a> for auctions matching the given words.",
  preview: function(pBlock, directObj) {
    if (directObj.text)
      pBlock.innerHTML = "Searches EBay for " + directObj.text;
    else
      pBlock.innerHTML = "Searches EBay for the given words.";
  }
});

CmdUtils.makeSearchCommand({
  name: "ask-search",
  url: "http://www.ask.com/web?q={QUERY}",
  icon: "http://www.ask.com/favicon.ico",
  description: "Searches <a href=\"http://www.ask.com\">Ask.com</a> for the given words.",
  preview: function(pBlock, directObj) {
    if (directObj.text)
      pBlock.innerHTML = "Searches Ask.com for " + directObj.text;
    else
      pBlock.innerHTML = "Searches Ask.com for the given words.";
  }
});

CmdUtils.makeSearchCommand({
  name: "answers-search",
  url: "http://www.answers.com/{QUERY}",
  icon: "http://www.answers.com/favicon.ico",
  description: "Searches <a href=\"http://www.answers.com\">Answers.com</a> for the given words.",
  preview: function(pBlock, directObj) {
    if (directObj.text)
      pBlock.innerHTML = "Searches Answers.com for " + directObj.text;
    else
      pBlock.innerHTML = "Searches Answers.com for the given words.";
  }
});

CmdUtils.CreateCommand({
  name: "yelp",
  takes: { "restaurant":noun_arb_text },
  // TODO: Should be noun_type_address, which is currently broken.
  // See http://labs.toolness.com/trac/ticket/44
  modifiers: { near:noun_arb_text },
  icon: "http://www.yelp.com/favicon.ico",
  description: "Searches <a href=\"http://www.yelp.com\">Yelp</a> for restaurants matching your words.",
  help: "You can search for restaurants near a certain location using the <i>near</i> modifier.  For example, try &quot;yelp pizza near boston&quot;.",
  execute: function( directObject, info ) {
    var doc = context.focusedWindow.document;
    var focused = context.focusedElement;

    if (doc.designMode == "on") {
      var data = globals.yelp[0];
      var msg = "<img style='float:left;margin:5px;border:solid #ccc 5px;' src='${photoUrl}'/><a href='${url}'>${name}</a> is a <img style='position:relative;top:5px;' src='${starUrl}'> restaurant in <a href='${whereUrl}'>${where}</a>, ${city}.<br/> It's been reviewed ${times} times.";
      var msg = CmdUtils.renderTemplate( msg, {
        url: data.url,
        starUrl: data.rating_img_url,
        photoUrl: data.photo_url_small,
        name: data.name,
        whereUrl: data.neighborhoods[0].url,
        where: data.neighborhoods[0].name,
        city: data.city,
        times: data.review_count
      });
      CmdUtils.setSelection( msg );
      return;
    }

    var query = directObject.text;
    var url = "http://www.yelp.com/search?find_desc={QUERY}&find_loc={NEAR}";
    url = url.replace( /{QUERY}/g, query);
    url = url.replace( /{NEAR}/g, info.near.text);

    Utils.openUrlInBrowser( url );
  },

  preview: function( pblock, directObject, info ) {
    var query = directObject.text;
    var url = "http://api.yelp.com/business_review_search?";

    if( query.length == 0 ) return;

    var loc = CmdUtils.getGeoLocation();
    var near = info.near.text || (loc.city + ", " + loc.state);

    var params = {
      term: query,
      num_biz_requested: 4,
      location: near,
      ywsid: "HbSZ2zXYuMnu1VTImlyA9A"
    };

    CmdUtils.previewGet( pblock, url, params, function(data) {
      globals.yelp = data.businesses;
      pblock.innerHTML = CmdUtils.renderTemplate(
        jQuery("#yelp-search", feed.dom).html(),
        {businesses: data.businesses}
      );
    }, "json");
  }
});

// -----------------------------------------------------------------
// WEATHER COMMANDS
// -----------------------------------------------------------------

var Temperature_Units = [
  'fahrenheit',
  'celsius'
];

var noun_type_temperature_units = new CmdUtils.NounType( "temperature units", Temperature_Units );

var WEATHER_TYPES = "none|tropical storm|hurricane|severe thunderstorms|thunderstorms|mixed rain and snow|mixed rain and sleet|mixed snow and sleet|freezing drizzle|drizzle|freezing rain|rain|rain|snow flurries|light snow showers|blowing snow|snow|hail|sleet|dust|foggy|haze|smoky|blustery|windy|cold|cloudy|mostly cloudy|mostly cloudy|partly cloudy|partly cloudy|clear|sunny|fair|fair|mixed rain and hail|hot|isolated thunderstorms|scattered thunderstorms|scattered thunderstorms|scattered showers|heavy snow|scattered snow showers|heavy snow|partly cloudy|thundershowers|snow showers|isolated thundershowers".split("|");

CmdUtils.CreateCommand({
  name: "weather",
  takes: {"location": noun_type_geolocation},
  modifiers: {"in": noun_type_temperature_units},
  icon: "http://www.wunderground.com/favicon.ico",
  description: "Checks the weather for a given location.",
  help: "Try issuing &quot;weather chicago&quot;.  It works with zip-codes, too.",
  execute: function( directObj ) {
    var location = directObj.text;
    var url = "http://www.wunderground.com/cgi-bin/findweather/getForecast?query=";
    url += escape( location );

    Utils.openUrlInBrowser( url );
  },

  preview: function( pblock, directObj, modifiers) {
    var location = directObj.text;
    if( location.length < 1 ) {
      pblock.innerHTML = "Gets the weather for a zip code/city.";
      return;
    }

    pblock.innerHTML = "Weather for " + location;

    //use either the specified "in" unit or get from geolocation
    var temp_units = 'celsius';
    if(!modifiers.in.text){
      var cc = CmdUtils.getGeoLocation().country_code;
      if(["US","UM","BZ"].indexOf(cc) != -1){
        temp_units = 'fahrenheit';
      }
    }else{
      temp_units = modifiers.in.text;
    }

    var url = "http://www.google.com/ig/api";
    CmdUtils.previewGet( pblock, url, {weather: location}, function(xml) {
      var el = jQuery(xml).find("current_conditions");
      if( el.length == 0 ) return;

      var condition = el.find("condition").attr("data");

      var place = jQuery(xml).find("forecast_information > city").attr("data");

      var weatherId = WEATHER_TYPES.indexOf( condition.toLowerCase() );
      var imgSrc = "http://l.yimg.com/us.yimg.com/i/us/nws/weather/gr/";
      imgSrc += weatherId + "d.png";

      //change wind speed to kmh based on geolocation
      var wind_text = el.find("wind_condition").attr("data").split("at");
      var wind_speed = parseInt(wind_text[1].split(" ")[1]);
      var wind_units = "mph";
      //http://en.wikipedia.org/wiki/Si_units
      //UK uses mph
      if(["US","UM", "LR", "MM", "GB"].indexOf(cc) == -1){
        wind_units = "km/h";
        wind_speed = wind_speed * 1.6;
      }

      var wind = wind_text[0] + " at " + wind_speed.toFixed(1) + wind_units;
      var weather = {
        condition: condition,
        temp_units: temp_units,
        tempc: el.find("temp_c").attr("data"),
        tempf: el.find("temp_f").attr("data"),
        humidity: el.find("humidity").attr("data"),
        wind: wind,
        img: imgSrc
      };

      weather["img"] = imgSrc;

      var html = CmdUtils.renderTemplate(
        jQuery("#weather-search", feed.dom).html(),
        {w:weather, location:place}
      );

      jQuery(pblock).html( html );
      }, "xml");
  }
});


function defineWord(word, callback) {
  var url = "http://services.aonaware.com/DictService/DictService.asmx/DefineInDict";
  var params = Utils.paramsToString({
    dictId: "wn", //wn: WordNet, gcide: Collaborative Dictionary
    word: word
  });

  Utils.ajaxGet(url + params, function(xml) {
    CmdUtils.loadJQuery( function(jQuery) {
      var text = jQuery(xml).find("WordDefinition").text();
      callback(text);
    });
  });
}

CmdUtils.CreateCommand({
  name: "define",
  description: "Gives the meaning of a word.",
  help: "Try issuing &quot;define aglet&quot;",
  icon: "http://www.answers.com/favicon.ico",
  takes: {"word": noun_arb_text},
  execute: function( directObj ) {
    var word = directObj.text;
    Utils.openUrlInBrowser( "http://www.answers.com/" + escape(word) );
  },
  preview: function( pblock, directObj ) {
    var word = directObj.text;
    if (word.length < 2)
      pblock.innerHTML = "Gives the definition of a word.";
    else {
      pblock.innerHTML = "Gives the definition of the word " + word + ".";
      defineWord( word, function(text){
        text = text.replace(/(\d+:)/g, "<br/><b>$&</b>");
        text = text.replace(/(1:)/g, "<br/>$&");
        text = text.replace(word, "<span style='font-size:18px;'>$&</span>");
        text = text.replace(/\[.*?\]/g, "");

        pblock.innerHTML = text;
      });
    }
  }
});
]]></script>
</body>
</html>